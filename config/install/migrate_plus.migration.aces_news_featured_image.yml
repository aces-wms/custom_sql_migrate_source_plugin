id: aces_news_featured_image
label: ACES NEWS Image File Import
migration_tags:
  - images
migration_group: aces_news
migration_dependencies:
  required:
    - aces_news
source:
  plugin: custom_sql_query
  key: migrate
  keys:
    - fid
  sql_query: "SELECT ln.nid as nid, fi.field_news_featured_image_target_id AS id, fi.entity_id, fi.field_news_featured_image_alt, fi.field_news_featured_image_title, fm.uri, fm.fid
              FROM node ln
              LEFT JOIN node__field_news_featured_image fi ON fi.entity_id = ln.nid
              LEFT JOIN file_managed fm ON fi.field_news_featured_image_target_id = fm.fid
              WHERE ln.type='news'
              ORDER BY ln.nid ASC"
#  folder:
#    plugin: explode
#    delimiter: '/'
#    source: uri
#    limit: 3
#  constants:
#    fileurl_1: 'https://localhost:55560/sites/default/files/news/'
#    fileurl_2: '@folder'
#    pub: 'public://news/'
destination:
  plugin: 'entity:file'

process:
  #this is how we figure out which node id our source is matched with
  #migration lookup compares the ids between the source and drupal's end result
  #and hands back the correct nid
  nid:
    plugin: migration_lookup
    migration: aces_news
    source: nid
    no_stub: true
  #title is here because this import "recreates" the existing news node
  #so we grab the already present title.
#  title:
#    plugin: entity_value
#    source: '@nid'
#    entity_type: node
#    langcode: en
#    field_name: title
  #build the url for the remote image. image is stored
  #under the id of the old news item
#  remote_url:
#    plugin: concat
#    source:
#      - constants/fileurl_1
#      - constants/fileurl_2
#  destination_name:
#    plugin: concat
#    source:
#      - constants/pub
#      - constants/fileurl_2
  #imports image from current mcb site and makes it a file entity.
  #drops images right into the public:// folder.
  image_download:
    plugin: image_import
    source: 'https://localhost:55560/sites/default/files/news/AIS%20group_sm.jpg'
    uid: 1
    skip_on_missing_source: true
    file_exists: rename
  #creates a media image entity from the downloaded image and attaches it to
  #the field on the referencing node's featured image
  field_if_meda_featured_image:
    plugin: file_image_to_media
    source: '@image_download'
    bundle: image
    field: node__field_if_meda_featured_image
